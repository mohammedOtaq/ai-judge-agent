
import streamlit as st
import json
import os

st.set_page_config(page_title="Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¨Ù‚Ø©", layout="centered")
st.title("â• Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©")

file_path = "precedents.json"
attachments_dir = "attachments"
os.makedirs(attachments_dir, exist_ok=True)

def load_precedents():
    if os.path.exists(file_path):
        with open(file_path, "r", encoding="utf-8") as f:
            return json.load(f)
    return []

def save_precedent(new_entry):
    precedents = load_precedents()
    precedents.append(new_entry)
    with open(file_path, "w", encoding="utf-8") as f:
        json.dump(precedents, f, ensure_ascii=False, indent=2)

with st.form("precedent_form"):
    case_number = st.text_input("ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©", "999/2025")
    case_type = st.selectbox("âš–ï¸ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ©", ["Ù…Ø¯Ù†ÙŠ Ø¬Ø²Ø¦ÙŠ", "Ù…Ø¯Ù†ÙŠ ÙƒÙ„ÙŠ", "ØªØ¬Ø§Ø±ÙŠ", "Ø¥ÙŠØ¬Ø§Ø±"])
    legal_articles = st.text_input("ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)", "267,742")
    summary = st.text_area("ğŸ“ ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ù‚Ø¶ÙŠØ©")
    decision = st.text_area("ğŸ“Œ Ø§Ù„Ù‚Ø±Ø§Ø±")
    reasoning = st.text_area("ğŸ“– Ø§Ù„Ø­ÙŠØ«ÙŠØ§Øª")
    keywords = st.text_input("ğŸ” ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)", "Ø¥ÙŠØ¬Ø§Ø±, Ø¹Ù‚Ø¯, Ø¶Ø±Ø±")

    uploaded_files = st.file_uploader(
        "ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù‚Ø¶ÙŠØ© (PDFØŒ ØµÙˆØ±ØŒ Ø£Ùˆ Word)", 
        type=["pdf", "jpg", "png", "jpeg", "docx"],
        accept_multiple_files=True
    )

    submitted = st.form_submit_button("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©")

    if submitted:
        saved_files = []
        for file in uploaded_files:
            file_path_out = os.path.join(attachments_dir, file.name)
            with open(file_path_out, "wb") as f:
                f.write(file.getbuffer())
            saved_files.append(file.name)

        new_case = {
            "Ø±Ù‚Ù…_Ø§Ù„Ù‚Ø¶ÙŠØ©": case_number.strip(),
            "Ù†ÙˆØ¹_Ø§Ù„Ù‚Ø¶ÙŠØ©": case_type,
            "Ø§Ù„Ù…ÙˆØ§Ø¯": [x.strip() for x in legal_articles.split(",")],
            "Ø§Ù„ÙˆØµÙ": summary.strip(),
            "Ø§Ù„Ù‚Ø±Ø§Ø±": decision.strip(),
            "Ø§Ù„Ø­ÙŠØ«ÙŠØ§Øª": reasoning.strip(),
            "Ø§Ù„ÙƒÙ„Ù…Ø§Øª_Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©": [x.strip() for x in keywords.split(",")],
            "Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª": saved_files
        }

        save_precedent(new_case)
        st.success("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
        if saved_files:
            st.write("ğŸ“ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:")
            st.write(saved_files)
st.markdown("---")
st.subheader("ğŸ¤– Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ø§Ù„Ø°ÙƒÙŠ")

if st.button("Ø§Ø³ØªØ´Ø§Ø±Ø© AI Agent"):
    prompt = f"""Ù‡Ø°Ù‡ Ù‚Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©:
Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©: {case_number}
Ù†ÙˆØ¹Ù‡Ø§: {case_type}
Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©: {legal_articles}
Ø§Ù„ÙˆØµÙ: {summary}
Ø§Ù„Ø­ÙŠØ«ÙŠØ§Øª: {reasoning}
Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø¶ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ³Ø¨ÙŠØ¨ØŸ"""

    with st.spinner("ğŸ¤– Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø¶ÙŠØ©..."):
        try:
            response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": "Ø£Ù†Øª Ù‚Ø§Ø¶Ù Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø¯Ù†ÙŠ. Ø£Ø¬Ø¨ Ø¨ØµÙŠØ§ØºØ© Ø±Ø³Ù…ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.4
            )
            result = response['choices'][0]['message']['content']
            st.success("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ:")
            st.text_area("ğŸ“‹ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­:", result, height=300)
        except Exception as e:
            st.error(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
